name: Agent (plan / qa / brainstorm)

"on":
  workflow_dispatch:
    inputs:
      target_env:
        description: "dev | staging | prod"
        required: true
        default: "staging"
        type: choice
        options: [dev, staging, prod]
      action:
        description: "PLAN | QA | BRAINSTORM"
        required: true
        default: "PLAN"
        type: choice
        options: [PLAN, QA, BRAINSTORM]
      prompt:
        description: "Prompt (required for BRAINSTORM; optional for PLAN if source_file is provided)"
        required: false
        default: ""
      source_file:
        description: "Optional (PLAN only): path to a markdown file inside ./product/ (e.g. product/brainstorms/20250101_1200_topic.md)"
        required: false
        default: ""

permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: me-central-1

jobs:
  agent:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate inputs
        shell: bash
        run: |
          set -euo pipefail
          ACTION="${{ inputs.action }}"
          PROMPT="${{ inputs.prompt }}"
          SOURCE_FILE="${{ inputs.source_file }}"

          if [[ "$ACTION" == "BRAINSTORM" && -z "$PROMPT" ]]; then
            echo "PROMPT is required for action=BRAINSTORM"
            exit 1
          fi

          if [[ "$ACTION" == "PLAN" && -z "$PROMPT" && -z "$SOURCE_FILE" ]]; then
            echo "PROMPT or source_file is required for action=PLAN"
            exit 1
          fi

          if [[ -n "$SOURCE_FILE" && "$ACTION" != "PLAN" ]]; then
            echo "source_file is only supported for action=PLAN"
            exit 1
          fi

          if [[ -n "$SOURCE_FILE" && "$SOURCE_FILE" != product/* ]]; then
            echo "source_file must be inside ./product/ (e.g. product/brainstorms/...)"
            exit 1
          fi

      - name: Configure AWS credentials (OIDC)
        if: ${{ inputs.action == 'QA' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::411714852748:role/GitHubDeployRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Resolve env -> cluster/service/tg
        if: ${{ inputs.action == 'QA' }}
        id: resolve
        shell: bash
        run: |
          set -euo pipefail
          case "${{ inputs.target_env }}" in
            dev)
              echo "CLUSTER=vancelian-dev-api-cluster" >> $GITHUB_ENV
              echo "SERVICE=vancelian-dev-api-svc" >> $GITHUB_ENV
              echo "TG_NAME=vancelian-dev-api-tg" >> $GITHUB_ENV
              ;;
            staging)
              echo "CLUSTER=vancelian-staging-api-cluster" >> $GITHUB_ENV
              echo "SERVICE=vancelian-staging-api-svc" >> $GITHUB_ENV
              echo "TG_NAME=vancelian-staging-api-tg" >> $GITHUB_ENV
              ;;
            prod)
              echo "CLUSTER=vancelian-prod-api-cluster" >> $GITHUB_ENV
              echo "SERVICE=vancelian-prod-api-svc" >> $GITHUB_ENV
              echo "TG_NAME=vancelian-prod-api-tg" >> $GITHUB_ENV
              ;;
            *)
              echo "Unknown env" >&2; exit 1;;
          esac

      - name: Collect AWS status (only for QA)
        if: ${{ inputs.action == 'QA' }}
        shell: bash
        run: |
          set -euo pipefail
          echo "## ECS service status" >> REPORT.md
          aws ecs describe-services \
            --region "$AWS_REGION" \
            --cluster "$CLUSTER" \
            --services "$SERVICE" \
            --query "services[0].{desired:desiredCount,running:runningCount,pending:pendingCount,taskDef:taskDefinition}" \
            --output json >> REPORT.md

          TASKDEF_ARN=$(aws ecs describe-services --region "$AWS_REGION" --cluster "$CLUSTER" --services "$SERVICE" --query "services[0].taskDefinition" --output text)
          echo -e "\n## Current image" >> REPORT.md
          aws ecs describe-task-definition --region "$AWS_REGION" --task-definition "$TASKDEF_ARN" --query "taskDefinition.containerDefinitions[0].image" --output text >> REPORT.md

          echo -e "\n## Target health" >> REPORT.md
          TG_ARN=$(aws elbv2 describe-target-groups --region "$AWS_REGION" --names "$TG_NAME" --query "TargetGroups[0].TargetGroupArn" --output text)
          aws elbv2 describe-target-health --region "$AWS_REGION" --target-group-arn "$TG_ARN" --output json >> REPORT.md

          echo -e "\n## Last ECS events" >> REPORT.md
          aws ecs describe-services \
            --region "$AWS_REGION" \
            --cluster "$CLUSTER" \
            --services "$SERVICE" \
            --query "services[0].events[0:12].message" \
            --output json >> REPORT.md

          cat REPORT.md

      - name: Upload QA report
        if: ${{ inputs.action == 'QA' }}
        uses: actions/upload-artifact@v4
        with:
          name: vancelian-qa-${{ inputs.target_env }}
          path: REPORT.md
          if-no-files-found: error
          retention-days: 14

      - name: Set up Python
        if: ${{ inputs.action == 'PLAN' || inputs.action == 'BRAINSTORM' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install agent deps
        if: ${{ inputs.action == 'PLAN' || inputs.action == 'BRAINSTORM' }}
        run: |
          python -m pip install --upgrade pip
          pip install -r agent/requirements.txt

      - name: Run generator (no OpenAI)
        if: ${{ inputs.action == 'PLAN' || inputs.action == 'BRAINSTORM' }}
        env:
          TARGET_ENV: ${{ inputs.target_env }}
          ACTION: ${{ inputs.action }}
          PROMPT: ${{ inputs.prompt }}
          SOURCE_FILE: ${{ inputs.source_file }}
        run: |
          mkdir -p product/plans product/brainstorms
          python agent/main.py

      - name: Upload PLAN artifact
        if: ${{ inputs.action == 'PLAN' }}
        uses: actions/upload-artifact@v4
        with:
          name: vancelian-plan-${{ inputs.target_env }}
          path: product/plans/*.md
          if-no-files-found: error
          retention-days: 14

      - name: Upload BRAINSTORM artifact
        if: ${{ inputs.action == 'BRAINSTORM' }}
        uses: actions/upload-artifact@v4
        with:
          name: vancelian-brainstorm-${{ inputs.target_env }}
          path: product/brainstorms/*.md
          if-no-files-found: error
          retention-days: 14
